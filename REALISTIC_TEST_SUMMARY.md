# ğŸ§ª ç¾å®Ÿçš„ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ E2Eæ¤œè¨¼ã‚µãƒãƒª

**Date**: 2025-11-01  
**ãƒ¦ãƒ¼ã‚¶ãƒ¼è¦æ±‚**: ã€Œè¤‡é›‘ã§ä¸­è¦æ¨¡ãƒ‡ãƒ¼ã‚¿ã‹ã¤äº‹å‰ã‚«ãƒ©ãƒ äº‹å‰ä¸ä¸€è‡´ã¨ã‹ã€è©¦ã—ã¦ãã ã•ã„ã­ã€‚ç¾å®Ÿçš„ã«å¯¾å¿œã—ãŸã€

---

## âœ… ç”Ÿæˆã—ãŸç¾å®Ÿçš„ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿

### ãƒ‡ãƒ¼ã‚¿ä»•æ§˜
- **è¡Œæ•°**: 5,000è¡Œï¼ˆä¸­è¦æ¨¡ï¼‰
- **åˆ—æ•°**: 13åˆ—
- **åˆ—å**: æ—¥æœ¬èªï¼ˆintentionally different from contractï¼‰
  - `é¡§å®¢ID`, `è³¼å…¥æ—¥æ™‚`, `ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³é©ç”¨`, `å£²ä¸Šé‡‘é¡`, `é¡§å®¢å¹´é½¢`, `æ€§åˆ¥`, `åœ°åŸŸ`, `å•†å“ã‚«ãƒ†ã‚´ãƒª`, etc.
- **æ¬ æå€¤**: 15% (727ã€œ787è¡Œ/åˆ—)
- **å¤–ã‚Œå€¤**: 5%ã®ãƒ‡ãƒ¼ã‚¿ã«å«ã‚€ï¼ˆå£²ä¸ŠÃ—10ï¼‰
- **ã‚«ãƒ†ã‚´ãƒªå¤‰æ•°**: æ€§åˆ¥ï¼ˆ3å€¤ï¼‰ã€åœ°åŸŸï¼ˆ5å€¤ï¼‰ã€å•†å“ã‚«ãƒ†ã‚´ãƒªï¼ˆ4å€¤ï¼‰
- **æ™‚ç³»åˆ—**: 2023/01/01 ã€œ 2024/12/31
- **Embedded Causal Effect**: ATE = 300 (intentional treatment effect)
- **Confounding**: å¹´é½¢ãŒtreatmentã¨outcomeã«å½±éŸ¿

### çµ±è¨ˆã‚µãƒãƒª
```
Treatment balance:
  Control (0): 2,774
  Treated (1): 2,226

Outcome (å£²ä¸Šé‡‘é¡):
  Mean: 1,565
  Std: 2,372
  Min: -213 (negative values exist)
  Max: 39,241 (outliers)

Missing values:
  å£²ä¸Šé‡‘é¡: 727 (15%)
  é¡§å®¢å¹´é½¢: 727 (15%)
  Webé–²è¦§æ™‚é–“_åˆ†: 787 (16%)
  ãƒ¡ãƒ¼ãƒ«é–‹å°ç‡: 758 (15%)
  å‰æœˆè³¼å…¥é¡: 761 (15%)
```

---

## ğŸ¯ ãƒ†ã‚¹ãƒˆç›®çš„

### NASA/Googleãƒ¬ãƒ™ãƒ«ã®ç¾å®Ÿçš„è¦ä»¶
1. âœ… **è¤‡é›‘ã•**: å˜ç´”ãª20è¡Œãƒ‡ãƒ¼ã‚¿ã§ã¯ãªãã€5,000è¡Œã®ç¾å®Ÿçš„ãƒ‡ãƒ¼ã‚¿
2. âœ… **åˆ—åä¸ä¸€è‡´**: contractã¨å…¨ãç•°ãªã‚‹åˆ—åï¼ˆæ—¥æœ¬èªï¼‰
3. âœ… **Data Quality Issues**:
   - æ¬ æå€¤ 15%
   - å¤–ã‚Œå€¤ã‚ã‚Š
   - Negative valuesã‚ã‚Š
4. âœ… **Schema-Free Mode**: contractãªã—ã§ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å¯èƒ½
5. âœ… **è‡ªå‹•Mappingæ¨è«–**: æ—¥æœ¬èªåˆ—åã‹ã‚‰è‹±èªroleåã¸ã®ãƒãƒƒãƒ”ãƒ³ã‚°

### æœŸå¾…ã•ã‚Œã‚‹Mapping
```python
{
  "unit_id": "é¡§å®¢ID",
  "time": "è³¼å…¥æ—¥æ™‚",
  "treatment": "ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³é©ç”¨",
  "y": "å£²ä¸Šé‡‘é¡",
  "cost": "åºƒå‘Šè²»",
  "features": ["é¡§å®¢å¹´é½¢", "æ€§åˆ¥", "åœ°åŸŸ", "å•†å“ã‚«ãƒ†ã‚´ãƒª", ...]
}
```

---

## âš ï¸ ç™ºç”Ÿã—ãŸå•é¡Œã¨ä¿®æ­£

### Problem 1: NaN values causing JSON serialization error

**ã‚¨ãƒ©ãƒ¼**:
```
ValueError: Out of range float values are not JSON compliant: nan
```

**åŸå› **:
- ç¾å®Ÿçš„ãƒ‡ãƒ¼ã‚¿ã«15%ã®æ¬ æå€¤ï¼ˆNaNï¼‰ã‚’å«ã‚€
- JSONã¯NaNã‚’ã‚µãƒãƒ¼ãƒˆã—ãªã„
- `df.to_dict(orient="records")`ãŒNaNã‚’ãã®ã¾ã¾è¿”ã™

**ä¿®æ­£** (`backend/gateway/app.py:182-184`):
```python
# Before
preview_rows = df.head(10).to_dict(orient="records")

# After
df_clean = df.replace([float('inf'), float('-inf')], None).fillna(value=None)
preview_rows = df_clean.head(10).to_dict(orient="records")
```

**NASA/Googleãƒ¬ãƒ™ãƒ«ã®æ•™è¨“**:
- ç¾å®Ÿçš„ãƒ‡ãƒ¼ã‚¿ã«ã¯å¿…ãšNaN/inf/negative valuesãŒå«ã¾ã‚Œã‚‹
- JSON serializationå‰ã«å¿…ãšã‚¯ãƒªãƒ¼ãƒ‹ãƒ³ã‚°ãŒå¿…è¦
- Fallbackãƒ‘ã‚¹ã‚‚åŒæ§˜ã«å®Ÿè£…ã™ã¹ã

---

## ğŸ”„ ç¾åœ¨ã®çŠ¶æ…‹

### ã‚µãƒ¼ãƒ“ã‚¹èµ·å‹•çŠ¶æ³
- âœ… Engine: http://localhost:8080 (PID: 204436) â†’ å†èµ·å‹•å¿…è¦
- âœ… Gateway: http://localhost:8081 (PID: 204477) â†’ å†èµ·å‹•å¿…è¦
- âœ… Frontend: http://localhost:4000 (PID: 204542) â†’ å†èµ·å‹•å¿…è¦

### å®Ÿæ–½æ¸ˆã¿
1. âœ… ç¾å®Ÿçš„ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ç”Ÿæˆ (`realistic_test_data.csv`, 5,000è¡Œ)
2. âœ… NaN handlingä¿®æ­£ (`backend/gateway/app.py`)
3. âš ï¸ ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ãƒ†ã‚¹ãƒˆ â†’ å†èµ·å‹•å¾Œã«å†è©¦è¡Œ

### æœªå®Ÿæ–½ï¼ˆæ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ï¼‰
1. [ ] ã‚µãƒ¼ãƒ“ã‚¹å†èµ·å‹•
2. [ ] ç¾å®Ÿçš„ãƒ‡ãƒ¼ã‚¿ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æˆåŠŸç¢ºèª
3. [ ] æ—¥æœ¬èªåˆ—åã§ã®è‡ªå‹•Mappingæ¨è«–
4. [ ] åˆ†æå®Ÿè¡Œï¼ˆã‚¨ãƒ©ãƒ¼ãªã—ï¼‰
5. [ ] å¯è¦–åŒ–ç”Ÿæˆç¢ºèª
6. [ ] çµæœãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ç¢ºèª

---

## ğŸ“‹ å®Œå…¨E2Eãƒ†ã‚¹ãƒˆãƒ—ãƒ­ãƒˆã‚³ãƒ«ï¼ˆç¾å®Ÿçš„ãƒ‡ãƒ¼ã‚¿ç‰ˆï¼‰

### Step 1: ã‚µãƒ¼ãƒ“ã‚¹å†èµ·å‹• âœ…
```bash
bash START.sh
```

### Step 2: ç¾å®Ÿçš„ãƒ‡ãƒ¼ã‚¿ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
```bash
curl -X POST http://localhost:8081/api/upload \
  -F "file=@realistic_test_data.csv"
```

**æœŸå¾…ã•ã‚Œã‚‹çµæœ**:
```json
{
  "ok": true,
  "dataset_id": "...",
  "meta": {
    "columns": ["é¡§å®¢ID", "è³¼å…¥æ—¥æ™‚", "ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³é©ç”¨", ...],
    "preview": [{...}]  // NaNãŒnullã«å¤‰æ›ã•ã‚Œã¦ã„ã‚‹
  },
  "candidates": {
    "y": ["å£²ä¸Šé‡‘é¡"],
    "treatment": ["ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³é©ç”¨"],
    "unit_id": ["é¡§å®¢ID"],
    "time": ["è³¼å…¥æ—¥æ™‚"],
    "cost": ["åºƒå‘Šè²»"]
  }
}
```

### Step 3: è‡ªå‹•Mappingæ¨è«–
```bash
curl -X POST http://localhost:8081/api/roles/infer \
  -H "Content-Type: application/json" \
  -d '{"dataset_id": "...", "min_confidence": 0.3}'
```

**æœŸå¾…ã•ã‚Œã‚‹çµæœ**:
```json
{
  "ok": true,
  "mapping": {
    "y": "å£²ä¸Šé‡‘é¡",
    "treatment": "ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³é©ç”¨",
    "unit_id": "é¡§å®¢ID",
    "time": "è³¼å…¥æ—¥æ™‚",
    "cost": "åºƒå‘Šè²»"
  },
  "confidence": 0.85
}
```

### Step 4: åˆ†æå®Ÿè¡Œ
```bash
curl -X POST http://localhost:8080/api/analyze/comprehensive \
  -H "Content-Type: application/json" \
  -d '{
    "dataset_id": "...",
    "df_path": "data/packets/.../data.parquet",
    "mapping": {
      "y": "å£²ä¸Šé‡‘é¡",
      "treatment": "ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³é©ç”¨",
      "unit_id": "é¡§å®¢ID",
      "time": "è³¼å…¥æ—¥æ™‚",
      "cost": "åºƒå‘Šè²»"
    },
    "objective": "GP28"
  }'
```

**æœŸå¾…ã•ã‚Œã‚‹çµæœ**:
- âœ… ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: 200 OK
- âœ… ATEæ¨å®šå€¤: ~300 (embedded effect)
- âœ… ä¿¡é ¼åŒºé–“è¨ˆç®—
- âœ… å¯è¦–åŒ–ç”Ÿæˆï¼ˆMatplotlib + WolframONEï¼‰

### Step 5: çµæœæ¤œè¨¼
```bash
ls -lh reports/figures/*.png
ls -lh reports/tables/*.csv
```

**æœŸå¾…ã•ã‚Œã‚‹ãƒ•ã‚¡ã‚¤ãƒ«**:
- [ ] `reports/figures/ate_bar.png`
- [ ] `reports/figures/covariate_balance.png`
- [ ] `reports/figures/cas_radar_chart.png`
- [ ] `reports/figures/causal_surface_3d.png`
- [ ] `reports/tables/estimates.csv`
- [ ] `reports/tables/summary_metrics.csv`

---

## ğŸ¯ æˆåŠŸåŸºæº–

### Minimum Viable Product (MVP)
- [ ] 5,000è¡Œãƒ‡ãƒ¼ã‚¿ãŒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æˆåŠŸ
- [ ] NaN/inf/negative valuesãŒæ­£ã—ãå‡¦ç†ã•ã‚Œã‚‹
- [ ] æ—¥æœ¬èªåˆ—åãŒèªè­˜ã•ã‚Œã‚‹
- [ ] è‡ªå‹•Mappingæ¨è«–ãŒå‹•ä½œã™ã‚‹
- [ ] åˆ†æãŒã‚¨ãƒ©ãƒ¼ãªãå®Ÿè¡Œã•ã‚Œã‚‹

### NASA/Googleãƒ¬ãƒ™ãƒ«
- [ ] è¤‡é›‘ãƒ‡ãƒ¼ã‚¿ï¼ˆæ¬ æå€¤15%ã€å¤–ã‚Œå€¤5%ï¼‰ãŒæ­£ã—ãå‡¦ç†ã•ã‚Œã‚‹
- [ ] åˆ—åä¸ä¸€è‡´ï¼ˆæ—¥æœ¬èª vs contractï¼‰ãŒå•é¡Œãªãå‹•ä½œã™ã‚‹
- [ ] ATEæ¨å®šå€¤ãŒæ­£ã—ã„ï¼ˆ~300ã€embedded effectï¼‰
- [ ] å¯è¦–åŒ–ãŒå…¨ã¦ç”Ÿæˆã•ã‚Œã‚‹
- [ ] Publication-ready reportsãŒç”Ÿæˆã•ã‚Œã‚‹

---

## ğŸ’¡ å­¦ã‚“ã æ•™è¨“

### æ•™è¨“1: ç©å…·ãƒ‡ãƒ¼ã‚¿ â‰  ç¾å®Ÿçš„ãƒ‡ãƒ¼ã‚¿

**Bad**:
- 20è¡Œã®å®Œç’§ãªãƒ‡ãƒ¼ã‚¿ã§ãƒ†ã‚¹ãƒˆ
- æ¬ æå€¤ãªã—ã€å¤–ã‚Œå€¤ãªã—
- è‹±èªã®ç°¡å˜ãªåˆ—å

**Good** (NASA/Googleãƒ¬ãƒ™ãƒ«):
- 5,000+è¡Œã®ç¾å®Ÿçš„ãƒ‡ãƒ¼ã‚¿
- æ¬ æå€¤15%ã€å¤–ã‚Œå€¤5%
- æ—¥æœ¬èª/è¤‡é›‘ãªåˆ—å
- Negative valuesã€inf valueså«ã‚€

### æ•™è¨“2: JSON Serializationå¯¾ç­–ã¯å¿…é ˆ

**å¿…é ˆå‡¦ç†**:
```python
df_clean = df.replace([float('inf'), float('-inf')], None).fillna(value=None)
```

**ç†ç”±**:
- ç¾å®Ÿçš„ãƒ‡ãƒ¼ã‚¿ã«ã¯å¿…ãšNaN/infãŒå«ã¾ã‚Œã‚‹
- JSONã¯ã“ã‚Œã‚‰ã‚’ã‚µãƒãƒ¼ãƒˆã—ãªã„
- ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ãŒå¿…é ˆ

### æ•™è¨“3: Schema-Free Modeã¯ç¾å®Ÿã«ä¸å¯æ¬ 

**ç†ç”±**:
- ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ‡ãƒ¼ã‚¿ã¯å¥‘ç´„ã¨ä¸€è‡´ã—ãªã„
- åˆ—åã¯å¤šæ§˜ï¼ˆæ—¥æœ¬èªã€è‹±èªã€ç•¥èªã€etc.ï¼‰
- äº‹å‰æ¤œè¨¼ã¯ä¸å¯èƒ½

**è§£æ±ºç­–**:
- ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æ™‚ã¯æ¤œè¨¼ãªã—
- Mappingã¯å¾Œã‹ã‚‰æŒ‡å®š
- è‡ªå‹•æ¨è«– + Manual override

---

**Generated**: 2025-11-01  
**Status**: NaNä¿®æ­£å®Œäº†ã€ã‚µãƒ¼ãƒ“ã‚¹å†èµ·å‹•å¾…ã¡  
**Next**: å®Œå…¨E2Eãƒ†ã‚¹ãƒˆå®Ÿè¡Œ

